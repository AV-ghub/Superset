# Sankey Diagram (Диаграмма потоков/Санкей)

**Что это такое?**
Это диаграмма, которая **показывает движение и преобразование некоторого ресурса** (денег, энергии, пользователей, товаров) от источника к пункту назначения через систему. Ширина стрелок пропорциональна количеству ресурса.

Представьте себе реку с притоками: маленькие ручейки (узкие стрелки) сливаются в более крупные (широкие стрелки).

**Какую задачу решает?**
Ответить на вопросы: **"Куда уходят деньги?"**, **"Откуда приходят клиенты?"**, **"Как товары перемещаются по цепочке поставок?"**. Идеально для визуализации:
*   Конверсии в воронках продаж.
*   Маршрутов пользователей на сайте.
*   Распределения бюджета.
*   Потерь энергии в системе.

**Простой пример: "Откуда приходят пользователи на сайт и что они там делают?"**

Допустим, у вас есть данные:
*   **Источники трафика:** `Google`, `Соцсети`, `Прямые заходы`.
*   **Целевые действия:** `Купили`, `Подписались на рассылку`, `Ушли`.

Диаграмма Санкей покажет это так:
```
[Google] ========\
                   \===========> [Купили] ====
[Соцсети] ====\     /==========> [Подписались]  } Общая сумма
              \===/                            } всех действий
[Прямые] =====/     \==========> [Ушли] ========
```
*   Широкая стрелка от `Google` к `Купили` значит, что этот источник дает больше всего покупателей.
*   Узкая стрелка от `Соцсети` к `Подписались` значит, что из соцсетей приходит мало подписчиков.
*   Вы сразу видите, что `Прямые заходы` в основном заканчиваются уходом с сайта (`Ушли`).

**Как настроить в Superset:**

Для построения нужны как минимум **два столбца** (источник и цель) и **один числовой показатель** (ширина потока).

1.  **Source (Источник):** Столбец, откуда начинается поток (например, `traffic_source`).
2.  **Target (Цель):** Столбец, куда направляется поток (например, `user_action`).
3.  **Metric (Метрика):** Числовой показатель, который определяет **ширину стрелок** (например, `COUNT(DISTINCT user_id)` для подсчета пользователей или `SUM(revenue)` для суммы денег).

**Важные особенности и ограничения:**

*   **Не для больших данных:** Диаграмма становится нечитаемой, если у вас сотни уникальных источников и целей. Идеально для 5-10 источников и 5-10 целей.
*   **Суммирование:** Superset автоматически суммирует метрики для одинаковых пар "Источник -> Цель". Не нужно агрегировать данные заранее.
*   **Циркулярные связи:** Санкей не поддерживает циклы (поток не может вернуться к тому же узлу). Это направленный ациклический граф (DAG).

---

## Сравнение с другими диаграммами

| Признак | Sankey Diagram | Heatmap | Cohort Chart |
| :--- | :--- | :--- | :--- |
| **Суть** | **Движение** ресурса между **категориями** | **Интенсивность** значения в **таблице** | **Сохранение** группы во **времени** |
| **Данные** | `Источник`, `Цель`, `Количество` | `Строка`, `Столбец`, `Значение` | `Время`, `Кохорта`, `Метрика` |
| **Вопрос** | "Куда уходит?" / "Откуда приходит?" | "Где максимум/минимум?" | "Сколько осталось со временем?" |

## Практический пример в Superset

**Задача:** Визуализировать путь клиента от первого визита до покупки.

1.  **Source:** `first_touch_channel` (первый канал привлечения: organic, paid, social).
2.  **Target:** `purchase_category` (категория купленного товара: electronics, clothes, books).
3.  **Metric:** `SUM(sales_amount)` (общая выручка).

**Что вы увидите:**
*   Широкая стрелка от `paid` к `electronics` скажет, что платная реклама хорошо конвертируется в продажи электроники.
*   Очень узкая стрелка от `social` к `books` покажет, что соцсети практически не продают книги.

**Итог:** Sankey Diagram — это мощный инструмент для визуализации **потоков и преобразований**. Он незаменим для анализа клиентских путей, финансовых потоков и любых процессов, где есть явные "откуда" и "куда". Начинайте с малого количества узлов, чтобы не перегрузить диаграмму.
